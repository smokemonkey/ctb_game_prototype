# 项目状态文档

## 项目概览
**项目名称**: pygame-sample  
**核心功能**: 游戏时间系统 + CTB战斗系统  
**最后更新**: 2025年6月12日  

## 核心模块结构

```
pygame-sample/
├── game_time/                 # 时间系统核心模块
│   ├── time_system.py        # 主要时间管理类
│   └── __init__.py           # 模块初始化
├── ctb/                      # CTB战斗系统
├── examples/                 # 演示文件
│   ├── time_web_demo.html    # 时间系统Web演示 (24KB, 705行)
│   ├── ctb_web_demo.html     # CTB系统Web演示
│   └── start_web_demo.py     # Web服务器启动脚本
├── tests/                    # 测试文件
└── README.md                 # 项目说明
```

## 当前功能状态

### ✅ 已完成功能

#### 1. 时间系统核心 (`game_time/time_system.py`)
- **基础时间管理**: 360天/年，30天/月，24小时/天
- **时间推进**: 按小时/天/年推进
- **纪元系统**: 支持多个历史纪元
- **🆕 锚定功能**: `anchor_era(era_name, gregorian_year)` - 将指定公元年份设为纪元元年
- **🆕 改元功能**: `add_era_node()` 基于锚定实现
- **日历格式化**: 公历和纪年两种显示方式

#### 2. Web演示界面 (`examples/time_web_demo.html`)
- **现代化UI**: 蓝色渐变主题，响应式布局
- **三栏布局**: 时间详情 | 状态统计 | 控制面板
- **时间推进控制**: 天数/小时推进，快速推进按钮
- **🆕 锚定控制**: 纪元锚定输入框和状态显示
- **🆕 改元控制**: 基于当前年份的改元功能
- **实时日志**: 操作记录和滚动显示
- **测试场景**: 自动化功能演示

#### 3. 服务器系统 (`examples/start_web_demo.py`)
- **智能启动**: 自动检测端口占用并清理
- **多模式**: 支持 ctb/time/both 三种演示模式
- **自动打开**: 启动后自动打开浏览器

### 🔧 核心设计决策

#### 锚定系统设计
- **锚定**: 可指定任意年份为纪元元年 (`anchor_era(name, year)`)
- **改元**: 只能将当前年份设为新纪元元年 (`changeEra(name)`)
- **改元是锚定的wrapper**: `changeEra()` 内部调用 `anchor_era(name, currentYear)`
- **优先级**: 锚定状态优先于原有纪元节点
- **限制**: 不允许锚定到未来年份

#### 时间计算逻辑
- **内部存储**: 以总小时数为基准 (`_totalHours`)
- **显示计算**: 实时从总小时数计算年月日
- **纪元年份**: `current_era_year = current_gregorian_year - era_start_year + 1`

### 🚫 已删除功能
- ❌ 复杂的纪年系统管理
- ❌ 时间跳转功能 (jumpToYear, jumpToDay)
- ❌ 独立的纪年添加功能 (addEraNode)
- ❌ 多个演示文件 (各种demo.py)

### 📝 最近修改记录

#### 2025-06-12 最新修改
1. **简化改元功能**: 
   - 删除年份输入框，只保留纪元名称输入
   - 改元自动使用当前年份作为元年
   - 更新UI提示文字

2. **清理冗余功能**:
   - 删除时间跳转控件和相关函数
   - 删除纪年管理功能
   - 简化测试场景

3. **界面优化**:
   - 保持现有的蓝色渐变主题
   - 三栏布局保持不变
   - 锚定状态实时显示

## 测试方法

### 启动Web演示
```bash
python examples/start_web_demo.py time
# 访问 http://localhost:8000/time_web_demo.html
```

### 功能测试流程
1. **基础时间推进**: 使用+1天、+10天等按钮
2. **锚定测试**: 输入"开元"和"713"，点击锚定
3. **改元测试**: 输入"永徽"，点击改元（自动使用当前年份）
4. **状态验证**: 观察锚定状态显示和纪年变化

## 技术栈
- **后端**: Python 3.x
- **前端**: HTML5 + CSS3 + JavaScript (ES6)
- **服务器**: Python内置HTTP服务器
- **测试**: Python unittest

## 下次开发提醒
- 当前锚定和改元功能已完成并测试通过
- Web界面已优化为最终版本
- 如需新功能，优先考虑在现有锚定基础上扩展
- 避免重新引入已删除的复杂功能 