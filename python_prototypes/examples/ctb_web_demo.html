<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTBÁ≥ªÁªüÊºîÁ§∫ - ÂõûÂêàÂà∂ÊàòÊñóÊó∂Èó¥ÁÆ°ÁêÜ</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.css">
    <script src="/config.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Microsoft YaHei', 'Simhei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr 350px;
            gap: 20px;
            padding: 20px;
            min-height: 600px;
        }

        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #3498db;
        }

        .panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }

        .info-text {
            font-family: 'Courier New', monospace;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-line;
            font-size: 13px;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
        }

        .scrollable-log {
            max-height: 300px;
            overflow-y: auto;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
        }

        .control-group h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px 0;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.success {
            background: linear-gradient(135deg, #27ae60 0%, #219a52 100%);
        }

        .btn.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .input-group label {
            color: #2c3e50;
            font-weight: bold;
            min-width: 80px;
        }

        .input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        @media (max-width: 1200px) {
            .content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #3498db #2c3e50;
        }

        .scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }

        .info-text, .scrollable-log {
            scrollbar-width: thin;
            scrollbar-color: #3498db #2c3e50;
        }

        .info-text::-webkit-scrollbar, .scrollable-log::-webkit-scrollbar {
            width: 6px;
        }

        .info-text::-webkit-scrollbar-track, .scrollable-log::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .info-text::-webkit-scrollbar-thumb, .scrollable-log::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 3px;
        }

        /* Ë°åÂä®È°∫Â∫èÈ¢ÑÊµãÁ´ñÊù°Ê†∑Âºè */
        .action-order-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 300px;
            padding: 10px 0;
            gap: 8px;
            background: linear-gradient(180deg, rgba(52, 152, 219, 0.1) 0%, rgba(52, 152, 219, 0.05) 100%);
            border-radius: 8px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .action-order-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            border: 3px solid #3498db;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .action-order-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .action-order-avatar.active {
            border-color: #e67e22;
            box-shadow: 0 0 12px rgba(230, 126, 34, 0.6);
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            animation: pulse 2s infinite;
        }

        .action-order-avatar.predicted {
            border-color: #27ae60;
            box-shadow: 0 0 12px rgba(39, 174, 96, 0.6);
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .action-order-avatar .faction-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .action-order-avatar .time-info {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #7f8c8d;
            white-space: nowrap;
            background: rgba(255,255,255,0.9);
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .action-order-avatar:hover .time-info {
            opacity: 1;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ÈòµËê•È¢úËâ≤Êò†Â∞Ñ */
        .faction-shu { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important; }
        .faction-wei { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%) !important; }
        .faction-wu { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%) !important; }
        .faction-qi { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%) !important; }
        .faction-chu { background: linear-gradient(135deg, #27ae60 0%, #219a52 100%) !important; }
        .faction-yan { background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%) !important; }
        .faction-han { background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%) !important; }
        .faction-zhao { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%) !important; }
        .faction-neutral { background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%) !important; }
    </style>
</head>
<body>
    <div id="app" class="ui container">
        <div class="container">
            <div class="header">
                <h1>üè∫ CTBÁ≥ªÁªüÊºîÁ§∫</h1>
                <p>Âü∫‰∫éÊò•ÁßãÊó∂‰ª£ÁöÑÂõûÂêàÂà∂ÊàòÊñóÊó∂Èó¥ÁÆ°ÁêÜÁ≥ªÁªü</p>
            </div>

            <div class="content">
                <!-- Â∑¶‰æßÈù¢Êùø -->
                <div>
                    <div class="panel">
                        <h3>üìÖ Êó∂Èó¥‰ø°ÊÅØ</h3>
                        <div class="info-text" id="timeInfo">Á≠âÂæÖÂàùÂßãÂåñ...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>üë• ËßíËâ≤‰ø°ÊÅØ</h3>
                        <div class="info-text" id="characterInfo">Á≠âÂæÖÂàùÂßãÂåñ...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>üß≠ Ë°åÂä®È°∫Â∫èÈ¢ÑÊµã</h3>
                        <div class="action-order-bar" id="actionOrderBar">
                            <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                                Á≠âÂæÖÂàùÂßãÂåñ...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‰∏≠Èó¥Èù¢Êùø -->
                <div>
                    <div class="panel">
                        <h3>‚öîÔ∏è CTBÁä∂ÊÄÅ</h3>
                        <div class="info-text" id="ctbStatus">Á≠âÂæÖÂàùÂßãÂåñ...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>‚è≥ Ë°åÂä®ÈòüÂàó</h3>
                        <div class="info-text" id="actionQueue">Á≠âÂæÖÂàùÂßãÂåñ...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>üî≠ Ë°åÂä®È¢ÑÊµã</h3>
                        <div class="info-text" id="predictionBar">Á≠âÂæÖÂàùÂßãÂåñ...</div>
                    </div>

                    <div class="panel" style="margin-top: 20px;">
                        <h3>üìú Ë°åÂä®ÂéÜÂè≤</h3>
                        <div class="scrollable-log" id="actionHistory">Á≠âÂæÖË°åÂä®...</div>
                    </div>
                </div>

                <!-- ÊéßÂà∂Èù¢Êùø -->
                <div class="controls">
                    <div class="control-group">
                        <h4>‚öôÔ∏è Á≥ªÁªüÊéßÂà∂</h4>
                        <button class="btn success" onclick="initializeCTB()">üöÄ ÂàùÂßãÂåñCTB</button>
                        <button class="btn" onclick="executeNextAction()">‚ñ∂Ô∏è ÊâßË°å‰∏ã‰∏™Ë°åÂä®</button>
                        <button class="btn warning" onclick="skipToNext()">‚è≠Ô∏è Ë∑≥ËΩ¨Êó∂Èó¥</button>
                        <button class="btn danger" onclick="resetCTB()">üîÑ ÈáçÁΩÆÁ≥ªÁªü</button>
                    </div>

                    <div class="control-group">
                        <h4>üéÆ ÊµãËØïÂäüËÉΩ</h4>
                        <button class="btn" onclick="toggleCharacterActive()">üîÑ ÂàáÊç¢ËßíËâ≤Áä∂ÊÄÅ</button>
                        <button class="btn" onclick="addRandomCharacter()">‚ûï Ê∑ªÂä†ÈöèÊú∫ËßíËâ≤</button>
                        <button class="btn" onclick="showPredictionDemo()">üîÆ È¢ÑÊµãÊºîÁ§∫</button>
                        <button class="btn" onclick="runMediumTest()">‚ö° 100‰∫∫ÊµãËØï</button>
                        <button class="btn warning" onclick="runStressTest()">üöÄ ÂàùÂßãÂåñ (ÂéãÊµãÊ®°Âºè)</button>
                    </div>

                    <div class="control-group">
                        <h4>üìä Á≥ªÁªüÁä∂ÊÄÅ</h4>
                        <div style="font-size: 12px; color: #7f8c8d;">
                            <div>Á≥ªÁªüÁä∂ÊÄÅ: <span id="systemStatus" style="font-weight: bold;">Êú™ÂàùÂßãÂåñ</span></div>
                            <div>ËßíËâ≤Êï∞Èáè: <span id="characterCount">0</span></div>
                            <div>Ë°åÂä®ÊÄªÊï∞: <span id="actionCount">0</span></div>
                            <div id="stressTestResult" style="margin-top: 10px; white-space: pre-wrap; font-weight: bold; color: #27ae60; font-size: 13px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ê®°ÊãüÁöÑÂêéÁ´ØÊï∞ÊçÆ
        let gameState = {
            timeManager: {
                currentYear: window.gameConfig.EPOCH_START_YEAR,
                currentMonth: 1,
                currentDay: 1,
                currentHour: 0,
                totalHours: 0
            },
            ctbManager: {
                isInitialized: false,
                characters: [],
                events: [], // Êîπ‰∏∫eventsÊï∞ÁªÑÔºåÂ≠òÂÇ®ÊâÄÊúâË∞ÉÂ∫¶ÁöÑ‰∫ã‰ª∂
                actionHistory: [],
                nextEventId: 1
            }
        };

        // ÊµãËØïËßíËâ≤Êï∞ÊçÆ (ÂØπÂ∫î examples/data/ctb_characters.py ‰∏≠ÁöÑÂü∫Á°ÄËßíËâ≤ÁªÑ)
        const testCharacters = [
            { id: "char_zhang", name: "Âº†‰∏â", faction: "ËúÄÂõΩ", isActive: true },
            { id: "char_li", name: "ÊùéÂõõ", faction: "È≠èÂõΩ", isActive: true },
            { id: "char_wang", name: "Áéã‰∫î", faction: "Âê¥ÂõΩ", isActive: true }
        ];

        // ËÆ°ÁÆó‰∏ãÊ¨°Ë°åÂä®Êó∂Èó¥ÔºàÊ®°ÊãüÊñ∞ÁöÑÈöèÊú∫Èó¥ÈöîÁÆóÊ≥ïÔºâ
        function calculateNextActionTime(currentTime, character) {
            // ‰ΩøÁî®‰∏âËßíÂàÜÂ∏ÉÔºöÊúÄÂ∞è1Â§©ÔºåÊúÄÂ§ß180Â§©Ôºå‰ºóÊï∞90Â§©
            const minDays = 1;
            const maxDays = 180;
            const modeDays = 90;

            // ÁÆÄÂåñÁöÑ‰∏âËßíÂàÜÂ∏ÉÂÆûÁé∞
            const u = Math.random();
            let days;
            if (u < 0.5) {
                days = minDays + Math.sqrt(u * 2) * (modeDays - minDays);
            } else {
                days = maxDays - Math.sqrt((1 - u) * 2) * (maxDays - modeDays);
            }

            const hours = Math.floor(days * 24);
            return currentTime + hours;
        }

        // Êõ¥Êñ∞ÊâÄÊúâÊòæÁ§∫
        function updateAllDisplays() {
            updateTimeDisplay();
            updateCTBStatus();
            updateCharacterInfo();
            updateActionQueue();
            updatePredictionBar();
            updateActionOrderBar();
            updateSystemStatus();
        }

        // Êõ¥Êñ∞Êó∂Èó¥ÊòæÁ§∫
        function updateTimeDisplay() {
            const tm = gameState.timeManager;
            const year = Math.abs(tm.currentYear);
            const era = tm.currentYear < 0 ? "ÂÖ¨ÂÖÉÂâç" : "ÂÖ¨ÂÖÉ";
            const eraYear = tm.currentYear - window.gameConfig.EPOCH_START_YEAR + 1;

            const timeText = `ÂΩìÂâçÊó∂Èó¥: ${era}${year}Âπ¥${tm.currentMonth}Êúà${tm.currentDay}Êó•${tm.currentHour}ÁÇπ
Á∫™Âπ¥: Êò•Áßã${eraYear}Âπ¥${tm.currentMonth}Êúà${tm.currentDay}Êó•${tm.currentHour}ÁÇπ
ÊÄªËÆ°Â∞èÊó∂: ${tm.totalHours}
ÊÄªËÆ°Â§©Êï∞: ${Math.floor(tm.totalHours / 24)}`;

            document.getElementById('timeInfo').textContent = timeText;
        }

        // Êõ¥Êñ∞CTBÁä∂ÊÄÅ
        function updateCTBStatus() {
            const ctb = gameState.ctbManager;
            const statusText = `Á≥ªÁªüÁä∂ÊÄÅ: ${ctb.isInitialized ? 'Â∑≤ÂàùÂßãÂåñ' : 'Êú™ÂàùÂßãÂåñ'}
‰∫ã‰ª∂Êï∞Èáè: ${ctb.events.length}
Ê¥ªË∑ÉËßíËâ≤: ${ctb.characters.filter(c => c.isActive).length}/${ctb.characters.length}
ÈòüÂàóÈïøÂ∫¶: ${ctb.actionQueue.length}
ÂéÜÂè≤ËÆ∞ÂΩï: ${ctb.actionHistory.length}`;

            document.getElementById('ctbStatus').textContent = statusText;
        }

        // Êõ¥Êñ∞ËßíËâ≤‰ø°ÊÅØ
        function updateCharacterInfo() {
            const characters = gameState.ctbManager.characters;
            let text = `=== ËßíËâ≤ÂàóË°® (ÂÖ± ${characters.length} ‰∏™) ===\n`;
            const displayLimit = 20;

            if (characters.length === 0) {
                text += "ÊöÇÊó†ËßíËâ≤";
            } else {
                const charactersToShow = characters.slice(0, displayLimit);

                charactersToShow.forEach(char => {
                    const status = char.isActive ? "‚úì" : "‚úó";
                    // Êü•ÊâæËßíËâ≤ÁöÑ‰∏ãÊ¨°Ë°åÂä®Êó∂Èó¥
                    const nextEvent = gameState.ctbManager.events.find(e => e.characterId === char.id);
                    let timeText = "Êú™Ë∞ÉÂ∫¶";

                    if (nextEvent) {
                        const timeUntil = nextEvent.triggerTime - gameState.timeManager.totalHours;
                        if (timeUntil <= 0) {
                            timeText = "Á´ãÂç≥ÊâßË°å";
                        } else {
                            const days = Math.floor(timeUntil / 24);
                            if (days > 0) {
                                timeText = `${days}Â§©Âêé`;
                            } else {
                                timeText = `${Math.floor(timeUntil)}Â∞èÊó∂Âêé`;
                            }
                        }
                    }

                    text += `${status} ${char.name} (${char.faction})\n`;
                    text += `  ‰∏ãÊ¨°Ë°åÂä®: ${timeText}\n`;
                });

                if (characters.length > displayLimit) {
                    text += `\n... (‰ªÖÊòæÁ§∫Ââç ${displayLimit} ‰∏™ËßíËâ≤)`;
                }
            }

            document.getElementById('characterInfo').textContent = text;
        }

        // Êõ¥Êñ∞Ë°åÂä®ÈòüÂàó
        function updateActionQueue() {
            const queue = gameState.ctbManager.actionQueue;
            let text = "=== Ë°åÂä®ÈòüÂàó ===\n";

            if (queue.length === 0) {
                text += "ÈòüÂàó‰∏∫Á©∫";
            } else {
                queue.slice(0, 8).forEach((action, index) => {
                    const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
                    const days = Math.floor(timeUntil / 24);
                    const hours = Math.floor(timeUntil % 24);

                    if (index === 0) {
                        text += `‚Üí ${action.characterName}\n`;
                    } else {
                        text += `  ${action.characterName}\n`;
                    }

                    if (timeUntil <= 0) {
                        text += `    Á´ãÂç≥ÊâßË°å\n`;
                    } else if (days > 0) {
                        text += `    ${days}Â§©${hours}Â∞èÊó∂Âêé\n`;
                    } else {
                        text += `    ${hours}Â∞èÊó∂Âêé\n`;
                    }
                });
            }

            document.getElementById('actionQueue').textContent = text;
        }

        // Êõ¥Êñ∞È¢ÑÊµãÊù°
        function updatePredictionBar() {
            const predictions = predictFutureActions(10); // È¢ÑÊµãÊú™Êù•10‰∏™Ë°åÂä®
            let text = "=== Êú™Êù•10Ê¨°Ë°åÂä®È¢ÑÊµã ===\n";

            if (predictions.length === 0) {
                text = "Êó†Ê≥ïÈ¢ÑÊµãÔºàÈòüÂàó‰∏∫Á©∫ÊàñÊú™ÂàùÂßãÂåñÔºâ";
            } else {
                predictions.forEach((action, index) => {
                    const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
                    const days = Math.floor(timeUntil / 24);
                    const hours = Math.floor(timeUntil % 24);

                    text += `${String(index + 1).padStart(2, ' ')}. ${action.characterName}\n`;

                    if (timeUntil <= 0) {
                        text += `     Á´ãÂç≥ÊâßË°å\n`;
                    } else if (days > 0) {
                        text += `     Â∞ÜÂú® ${days}Â§©${hours}Â∞èÊó∂ÂêéË°åÂä®\n`;
                    } else {
                        text += `     Â∞ÜÂú® ${hours}Â∞èÊó∂ÂêéË°åÂä®\n`;
                    }
                });
            }

            document.getElementById('predictionBar').textContent = text;
        }

        // Êõ¥Êñ∞Ë°åÂä®È°∫Â∫èÈ¢ÑÊµãÁ´ñÊù°
        function updateActionOrderBar(predictedOrder = null) {
            const bar = document.getElementById('actionOrderBar');
            const ctb = gameState.ctbManager;

            if (!ctb.isInitialized || ctb.actionQueue.length === 0) {
                bar.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">Á≠âÂæÖÂàùÂßãÂåñ...</div>';
                return;
            }

            // ‰ΩøÁî®È¢ÑÊµãÈ°∫Â∫èÊàñÂΩìÂâçÈ°∫Â∫è
            const order = predictedOrder || ctb.actionQueue;
            bar.innerHTML = '';

            // ÊòæÁ§∫Ââç8‰∏™Ë°åÂä®
            order.slice(0, 8).forEach((action, index) => {
                const character = ctb.characters.find(c => c.id === action.characterId);
                if (!character) return;

                const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
                const days = Math.floor(timeUntil / 24);
                const hours = Math.floor(timeUntil % 24);

                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'action-order-avatar';

                // Ê∑ªÂä†ÈòµËê•Ê†∑ÂºèÊàñËá™ÂÆö‰πâÈ¢úËâ≤
                if (character.customColor) {
                    // ‰ΩøÁî®Ëá™ÂÆö‰πâÈ¢úËâ≤
                    avatarDiv.style.background = `linear-gradient(135deg, ${character.customColor} 0%, ${darkenColor(character.customColor, 0.2)} 100%)`;
                    avatarDiv.style.color = 'white';
                } else {
                    // ‰ΩøÁî®ÈòµËê•Ê†∑Âºè
                    const factionClass = getFactionClass(character.faction);
                    if (factionClass) {
                        avatarDiv.classList.add(factionClass);
                    }
                }

                // ÂΩìÂâçË°åÂä®È´ò‰∫Æ
                if (index === 0) {
                    avatarDiv.classList.add('active');
                }

                // È¢ÑÊµãÁä∂ÊÄÅ
                if (predictedOrder && index < 3) {
                    avatarDiv.classList.add('predicted');
                }

                // Â§¥ÂÉèÂÜÖÂÆπÔºà‰ΩøÁî®ÂêçÂ≠óÈ¶ñÂ≠óÊØçÔºâ
                avatarDiv.textContent = character.name[0];

                // ÈòµËê•ÂæΩÁ´†
                const badgeDiv = document.createElement('div');
                badgeDiv.className = 'faction-badge';
                badgeDiv.textContent = character.faction[0];
                badgeDiv.style.backgroundColor = character.customColor || getFactionColor(character.faction);
                avatarDiv.appendChild(badgeDiv);

                // Êó∂Èó¥‰ø°ÊÅØ
                const timeDiv = document.createElement('div');
                timeDiv.className = 'time-info';
                if (timeUntil <= 0) {
                    timeDiv.textContent = 'Á´ãÂç≥';
                } else if (days > 0) {
                    timeDiv.textContent = `${days}Â§©${hours}Êó∂`;
                } else {
                    timeDiv.textContent = `${hours}Êó∂`;
                }
                avatarDiv.appendChild(timeDiv);

                // ÁÇπÂáª‰∫ã‰ª∂ÔºàÂèØ‰ª•Êâ©Â±ï‰∏∫ÊäÄËÉΩÈÄâÊã©Á≠âÔºâ
                avatarDiv.onclick = function() {
                    showCharacterDetails(character, action);
                };

                bar.appendChild(avatarDiv);
            });

            // Â¶ÇÊûúË°åÂä®Êï∞ÈáèË∂ÖËøá8‰∏™ÔºåÊòæÁ§∫Êõ¥Â§öÊèêÁ§∫
            if (order.length > 8) {
                const moreDiv = document.createElement('div');
                moreDiv.style.textAlign = 'center';
                moreDiv.style.color = '#7f8c8d';
                moreDiv.style.fontSize = '12px';
                moreDiv.style.marginTop = '10px';
                moreDiv.textContent = `ËøòÊúâ ${order.length - 8} ‰∏™Ë°åÂä®...`;
                bar.appendChild(moreDiv);
            }
        }

        // Ëé∑ÂèñÈòµËê•CSSÁ±ªÂêç
        function getFactionClass(faction) {
            const factionMap = {
                'ËúÄÂõΩ': 'faction-shu',
                'È≠èÂõΩ': 'faction-wei',
                'Âê¥ÂõΩ': 'faction-wu',
                'ÈΩêÂõΩ': 'faction-qi',
                'Ê•öÂõΩ': 'faction-chu',
                'ÁáïÂõΩ': 'faction-yan',
                'Èü©ÂõΩ': 'faction-han',
                'ËµµÂõΩ': 'faction-zhao',
                '‰∏≠Á´ã': 'faction-neutral'
            };
            return factionMap[faction] || '';
        }

        // Ëé∑ÂèñÈòµËê•È¢úËâ≤
        function getFactionColor(faction) {
            const colorMap = {
                'ËúÄÂõΩ': '#e74c3c',
                'È≠èÂõΩ': '#3498db',
                'Âê¥ÂõΩ': '#f39c12',
                'ÈΩêÂõΩ': '#9b59b6',
                'Ê•öÂõΩ': '#27ae60',
                'ÁáïÂõΩ': '#1abc9c',
                'Èü©ÂõΩ': '#34495e',
                'ËµµÂõΩ': '#e67e22',
                '‰∏≠Á´ã': '#95a5a6'
            };
            return colorMap[faction] || '#95a5a6';
        }

        // È¢úËâ≤ÂèòÊöóËæÖÂä©ÂáΩÊï∞
        function darkenColor(color, factor) {
            // ÁÆÄÂçïÁöÑÈ¢úËâ≤ÂèòÊöóÁÆóÊ≥ï
            const hex = color.replace('#', '');
            const r = Math.max(0, parseInt(hex.substr(0, 2), 16) * (1 - factor));
            const g = Math.max(0, parseInt(hex.substr(2, 2), 16) * (1 - factor));
            const b = Math.max(0, parseInt(hex.substr(4, 2), 16) * (1 - factor));
            return `#${Math.round(r).toString(16).padStart(2, '0')}${Math.round(g).toString(16).padStart(2, '0')}${Math.round(b).toString(16).padStart(2, '0')}`;
        }

        // ÊòæÁ§∫ËßíËâ≤ËØ¶ÊÉÖÔºàÂèØÊâ©Â±ï‰∏∫ÊäÄËÉΩÈÄâÊã©Á≠âÔºâ
        function showCharacterDetails(character, action) {
            const timeUntil = action.triggerTime - gameState.timeManager.totalHours;
            const days = Math.floor(timeUntil / 24);
            const hours = Math.floor(timeUntil % 24);

            let timeText = '';
            if (timeUntil <= 0) {
                timeText = 'Á´ãÂç≥ÊâßË°å';
            } else if (days > 0) {
                timeText = `${days}Â§©${hours}Â∞èÊó∂Âêé`;
            } else {
                timeText = `${hours}Â∞èÊó∂Âêé`;
            }

            addActionLog(`ËßíËâ≤ËØ¶ÊÉÖ: ${character.name} (${character.faction}) - ${timeText}Ë°åÂä®`);
        }

        // Êõ¥Êñ∞Á≥ªÁªüÁä∂ÊÄÅ
        function updateSystemStatus() {
            const ctb = gameState.ctbManager;
            document.getElementById('systemStatus').textContent = ctb.isInitialized ? 'Â∑≤ÂàùÂßãÂåñ' : 'Êú™ÂàùÂßãÂåñ';
            document.getElementById('characterCount').textContent = ctb.characters.length;
            document.getElementById('actionCount').textContent = ctb.actionHistory.length;
        }

        // Ê∑ªÂä†Ë°åÂä®ÂéÜÂè≤ËÆ∞ÂΩï
        function addActionLog(message) {
            const historyDiv = document.getElementById('actionHistory');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

            historyDiv.appendChild(logEntry);
            historyDiv.scrollTop = historyDiv.scrollHeight;

            // ‰øùÊåÅÊúÄÊñ∞50Êù°ËÆ∞ÂΩï
            while (historyDiv.children.length > 50) {
                historyDiv.removeChild(historyDiv.firstChild);
            }
        }

        // È¢ÑÊµãÊú™Êù•Ë°åÂä®
        function predictFutureActions(count) {
            const ctb = gameState.ctbManager;
            if (!ctb.isInitialized || ctb.actionQueue.length === 0) {
                return [];
            }

            // ‰ΩøÁî®Ê∑±Êã∑Ë¥ùÂàõÂª∫Ê®°ÊãüÁéØÂ¢É
            let simQueue = JSON.parse(JSON.stringify(ctb.actionQueue));

            const predictions = [];

            for (let i = 0; i < count; i++) {
                if (simQueue.length === 0) break;

                // Ëé∑Âèñ‰∏ã‰∏Ä‰∏™Ë°åÂä® (JS‰∏≠shift()‰ªéÊï∞ÁªÑÂ§¥ÈÉ®ÂèñÂá∫)
                const nextAction = simQueue.shift();
                predictions.push(nextAction);

                // ÂÆâÊéíËØ•ËßíËâ≤ÁöÑ‰∏ã‰∏ÄÊ¨°Ë°åÂä®
                const character = ctb.characters.find(c => c.id === nextAction.characterId);
                if (character && character.isActive) {
                    // ‰ΩøÁî®Êñ∞ÁöÑÈöèÊú∫Èó¥ÈöîÁÆóÊ≥ï
                    const nextTriggerTime = calculateNextActionTime(nextAction.triggerTime, character);

                    simQueue.push({
                        id: -1, // Ê®°ÊãüË°åÂä®ID
                        characterId: character.id,
                        characterName: character.name,
                        triggerTime: nextTriggerTime,
                        actionType: 'attack'
                    });

                    // ‰øùÊåÅÊ®°ÊãüÈòüÂàóÊéíÂ∫è
                    simQueue.sort((a, b) => a.triggerTime - b.triggerTime);
                }
            }

            return predictions;
        }

        // CTBÁ≥ªÁªüÊéßÂà∂ÂáΩÊï∞
        function initializeCTB() {
            // 1. ÂÖàÊ∑ªÂä†ËßíËâ≤ÔºàÊ®°ÊãüÁúüÂÆûÁ≥ªÁªüÁöÑadd_characterÔºâ
            gameState.ctbManager.characters = [];
            testCharacters.forEach(char => {
                gameState.ctbManager.characters.push({...char});
            });

            // 2. ÁÑ∂ÂêéÂàùÂßãÂåñÁ≥ªÁªüÔºàÊ®°ÊãüÁúüÂÆûÁ≥ªÁªüÁöÑinitialize_ctbÔºâ
            if (gameState.ctbManager.characters.length === 0) {
                addActionLog("ÈîôËØØÔºöÊ≤°ÊúâËßíËâ≤ÔºåÊó†Ê≥ïÂàùÂßãÂåñCTBÁ≥ªÁªü");
                return;
            }

            gameState.ctbManager.events = [];
            gameState.ctbManager.actionQueue = [];

            // ‰∏∫ÊØè‰∏™Ê¥ªË∑ÉËßíËâ≤ÂÆâÊéíÂàùÂßãË°åÂä®Êó∂Èó¥
            gameState.ctbManager.characters.forEach(char => {
                if (char.isActive) {
                    // ‰ΩøÁî®Êñ∞ÁöÑÈöèÊú∫Èó¥ÈöîÁÆóÊ≥ïËÆ°ÁÆóÂàùÂßãË°åÂä®Êó∂Èó¥
                    const initialDelayHours = Math.floor(Math.random() * 24 * 30) + 1; // 1-30Â§©ÈöèÊú∫
                    const triggerTime = gameState.timeManager.totalHours + initialDelayHours;

                    const event = {
                        id: gameState.ctbManager.nextEventId++,
                        characterId: char.id,
                        characterName: char.name,
                        triggerTime: triggerTime,
                        actionType: 'attack'
                    };

                    // Ê∑ªÂä†Âà∞‰∫ã‰ª∂ÂàóË°®ÂíåË°åÂä®ÈòüÂàó
                    gameState.ctbManager.events.push(event);
                    gameState.ctbManager.actionQueue.push(event);
                }
            });

            // ÊåâËß¶ÂèëÊó∂Èó¥ÊéíÂ∫è
            gameState.ctbManager.actionQueue.sort((a, b) => a.triggerTime - b.triggerTime);

            // ËÆæÁΩÆÁ≥ªÁªü‰∏∫Â∑≤ÂàùÂßãÂåñÁä∂ÊÄÅ
            gameState.ctbManager.isInitialized = true;

            addActionLog(`CTBÁ≥ªÁªüÂ∑≤ÂàùÂßãÂåñÔºåÊ∑ªÂä†‰∫Ü ${gameState.ctbManager.characters.length} ‰∏™ËßíËâ≤`);
            updateAllDisplays();
        }

        function executeNextAction() {
            if (!gameState.ctbManager.isInitialized) {
                addActionLog("ËØ∑ÂÖàÂàùÂßãÂåñCTBÁ≥ªÁªü");
                return;
            }

            const action = gameState.ctbManager.actionQueue.shift();
            if (!action) {
                addActionLog("Ê≤°ÊúâÂæÖÊâßË°åÁöÑË°åÂä®");
                return;
            }

            // ‰ªéeventsÊï∞ÁªÑ‰∏≠ÁßªÈô§Â∑≤ÊâßË°åÁöÑ‰∫ã‰ª∂
            const eventIndex = gameState.ctbManager.events.findIndex(e => e.id === action.id);
            if (eventIndex !== -1) {
                gameState.ctbManager.events.splice(eventIndex, 1);
            }

            // Êé®ËøõÊó∂Èó¥Âà∞Ë°åÂä®Êó∂Èó¥
            gameState.timeManager.totalHours = action.triggerTime;
            updateTimeFromTotalHours();

            // ËÆ∞ÂΩïË°åÂä®
            const tm = gameState.timeManager;
            const year = Math.abs(tm.currentYear);
            const era = tm.currentYear < 0 ? "ÂÖ¨ÂÖÉÂâç" : "ÂÖ¨ÂÖÉ";
            const eraYear = tm.currentYear - window.gameConfig.EPOCH_START_YEAR + 1;

            const logMessage = `Êò•Áßã${eraYear}Âπ¥${tm.currentMonth}Êúà${tm.currentDay}Êó•${tm.currentHour}ÁÇπ (${era}${year}Âπ¥${tm.currentMonth}Êúà${tm.currentDay}Êó•${tm.currentHour}ÁÇπ) - ${action.characterName} Ë°åÂä®`;
            addActionLog(logMessage);

            // Ê∑ªÂä†Âà∞ÂéÜÂè≤
            gameState.ctbManager.actionHistory.push({
                ...action,
                executedTime: action.triggerTime,
                timestamp: Date.now()
            });

            // ‰∏∫ËØ•ËßíËâ≤ÂÆâÊéí‰∏ãÊ¨°Ë°åÂä®
            const character = gameState.ctbManager.characters.find(c => c.id === action.characterId);
            if (character && character.isActive) {
                // ‰ΩøÁî®Êñ∞ÁöÑÈöèÊú∫Èó¥ÈöîÁÆóÊ≥ï
                const nextTriggerTime = calculateNextActionTime(action.triggerTime, character);

                const nextEvent = {
                    id: gameState.ctbManager.nextEventId++,
                    characterId: character.id,
                    characterName: character.name,
                    triggerTime: nextTriggerTime,
                    actionType: 'attack'
                };

                gameState.ctbManager.events.push(nextEvent);
                gameState.ctbManager.actionQueue.push(nextEvent);

                // ÈáçÊñ∞ÊéíÂ∫èÈòüÂàó
                gameState.ctbManager.actionQueue.sort((a, b) => a.triggerTime - b.triggerTime);
            }

            updateAllDisplays();
        }

        function skipToNext() {
            if (!gameState.ctbManager.isInitialized) {
                addActionLog("ËØ∑ÂÖàÂàùÂßãÂåñCTBÁ≥ªÁªü");
                return;
            }

            const nextAction = gameState.ctbManager.actionQueue[0];
            if (!nextAction) {
                addActionLog("Ê≤°ÊúâÂæÖÊâßË°åÁöÑË°åÂä®");
                return;
            }

            // Áõ¥Êé•Ë∑≥ËΩ¨Êó∂Èó¥
            gameState.timeManager.totalHours = nextAction.triggerTime;
            updateTimeFromTotalHours();

            addActionLog(`Êó∂Èó¥Â∑≤Ë∑≥ËΩ¨Âà∞ ${nextAction.characterName} ÁöÑË°åÂä®Êó∂Èó¥`);
            updateAllDisplays();
        }

        function resetCTB(silent = false) {
            gameState.ctbManager = {
                isInitialized: false,
                characters: [],
                events: [],
                actionQueue: [],
                actionHistory: [],
                nextEventId: 1
            };

            if (!silent) {
                addActionLog("CTBÁ≥ªÁªüÂ∑≤ÈáçÁΩÆ");
            }
            // Clear stress test results on reset
            const resultDiv = document.getElementById('stressTestResult');
            if (resultDiv) resultDiv.textContent = "";

            updateAllDisplays();
        }

        function toggleCharacterActive() {
            if (gameState.ctbManager.characters.length > 0) {
                const char = gameState.ctbManager.characters[0];
                char.isActive = !char.isActive;
                const status = char.isActive ? "ÊøÄÊ¥ª" : "ÂÅúÁî®";
                addActionLog(`${char.name} Â∑≤${status}`);
                updateAllDisplays();
            }
        }

        function addRandomCharacter() {
            const names = ["ËµµÂÖ≠", "Â≠ô‰∏É", "Âë®ÂÖ´", "Âê¥‰πù", "ÈÉëÂçÅ"];
            const factions = ["ÈΩêÂõΩ", "Ê•öÂõΩ", "ÁáïÂõΩ", "Èü©ÂõΩ", "ËµµÂõΩ"];

            const randomName = names[Math.floor(Math.random() * names.length)];
            const randomFaction = factions[Math.floor(Math.random() * factions.length)];

            const newChar = {
                id: `char_${Date.now()}`,
                name: randomName,
                faction: randomFaction,
                isActive: true
            };

            gameState.ctbManager.characters.push(newChar);
            addActionLog(`Ê∑ªÂä†ËßíËâ≤: ${randomName}(${randomFaction})`);
            updateAllDisplays();
        }

        // È¢ÑÊµãÊºîÁ§∫ÂäüËÉΩ
        function showPredictionDemo() {
            if (!gameState.ctbManager.isInitialized) {
                addActionLog("ËØ∑ÂÖàÂàùÂßãÂåñCTBÁ≥ªÁªü");
                return;
            }

            const ctb = gameState.ctbManager;
            if (ctb.actionQueue.length < 2) {
                addActionLog("ÈúÄË¶ÅËá≥Â∞ë2‰∏™Ë°åÂä®ÊâçËÉΩÊºîÁ§∫È¢ÑÊµãÊïàÊûú");
                return;
            }

            // ÂàõÂª∫È¢ÑÊµãÈ°∫Â∫èÔºàÊ®°ÊãüÁ¨¨‰∏Ä‰∏™ËßíËâ≤Ë°åÂä®ÂêéÔºåÁ¨¨‰∫å‰∏™ËßíËâ≤ÊèêÂâçË°åÂä®Ôºâ
            const predictedOrder = [...ctb.actionQueue];

            // Ê®°ÊãüÁ¨¨‰∏Ä‰∏™ËßíËâ≤Ë°åÂä®ÂêéÔºåÁ¨¨‰∫å‰∏™ËßíËâ≤ÁöÑË°åÂä®Êó∂Èó¥ÊèêÂâç
            if (predictedOrder.length >= 2) {
                const firstAction = predictedOrder[0];
                const secondAction = predictedOrder[1];

                // Ê®°ÊãüÁ¨¨‰∫å‰∏™ËßíËâ≤Âõ†‰∏∫ÊüêÁßçÊäÄËÉΩÊàñÊïàÊûúÊèêÂâçË°åÂä®
                const timeAdvance = Math.floor(Math.random() * 24) + 1; // ÊèêÂâç1-24Â∞èÊó∂
                secondAction.triggerTime = firstAction.triggerTime + timeAdvance;

                // ÈáçÊñ∞ÊéíÂ∫è
                predictedOrder.sort((a, b) => a.triggerTime - b.triggerTime);

                addActionLog(`üîÆ È¢ÑÊµãÊºîÁ§∫: ÂÅáËÆæ${firstAction.characterName}Ë°åÂä®ÂêéÔºå${secondAction.characterName}ÊèêÂâç${timeAdvance}Â∞èÊó∂Ë°åÂä®`);

                // ÊòæÁ§∫È¢ÑÊµãÊïàÊûú
                updateActionOrderBar(predictedOrder);

                // 3ÁßíÂêéÊÅ¢Â§çÂéüÂßãÊòæÁ§∫
                setTimeout(() => {
                    updateActionOrderBar();
                    addActionLog("È¢ÑÊµãÊºîÁ§∫ÁªìÊùüÔºåÊÅ¢Â§çÂéüÂßãÈ°∫Â∫è");
                }, 3000);
            }
        }

        // ‰ªéÊÄªÂ∞èÊó∂Êï∞Êõ¥Êñ∞Êó•ÊúüÊó∂Èó¥
        function updateTimeFromTotalHours() {
            const totalHours = gameState.timeManager.totalHours;
            const totalDays = Math.floor(totalHours / 24);
            const hours = totalHours % 24;

            // ÁÆÄÂåñÁöÑÊó•ÊúüËÆ°ÁÆóÔºà360Â§©/Âπ¥Ôºå30Â§©/ÊúàÔºâ
            const startYear = window.gameConfig.EPOCH_START_YEAR;
            const years = Math.floor(totalDays / 360);
            const remainingDays = totalDays % 360;
            const months = Math.floor(remainingDays / 30);
            const days = remainingDays % 30;

            gameState.timeManager.currentYear = startYear + years;
            gameState.timeManager.currentMonth = months + 1;
            gameState.timeManager.currentDay = days + 1;
            gameState.timeManager.currentHour = hours;
        }

        // 100‰∫∫ÊµãËØïÊ®°Âºè
        function runMediumTest() {
            addActionLog("‚ö° ÂºÄÂßã100‰∫∫ÊµãËØïÂàùÂßãÂåñ...");

            const resultDiv = document.getElementById('stressTestResult');
            resultDiv.textContent = "ÂàùÂßãÂåñ‰∏≠...";

            setTimeout(() => {
                try {
                    // 1. ÈáçÁΩÆÁ≥ªÁªüÁä∂ÊÄÅ
                    resetCTB(true);

                    // 2. ËÆæÁΩÆÂèÇÊï∞
                    const characterCount = 100;
                    const averageIntervalDays = 30; // Êõ¥Áü≠ÁöÑÈó¥ÈöîÔºå‰æø‰∫éËßÇÂØü
                    const baseFactor = gameState.ctbManager.baseFactor;
                    const targetSpeed = baseFactor / averageIntervalDays;

                    // 3. ÁîüÊàêÈöèÊú∫ÂêçÂ≠óÂíåÈ¢úËâ≤
                    const surnames = ['Âº†', 'Êùé', 'Áéã', 'Ëµµ', 'Èôà', 'Âàò', 'Êù®', 'ÈªÑ', 'Âë®', 'Âê¥', 'Âæê', 'Â≠ô', 'ËÉ°', 'Êú±', 'È´ò', 'Êûó', '‰Ωï', 'ÈÉ≠', 'È©¨', 'ÁΩó', 'Ê¢Å', 'ÂÆã', 'ÈÉë', 'Ë∞¢', 'Èü©', 'Âîê', 'ÂÜØ', '‰∫é', 'Ëë£', 'Ëêß', 'Á®ã', 'Êõπ', 'Ë¢Å', 'ÈÇì', 'ËÆ∏', 'ÂÇÖ', 'Ê≤à', 'Êõæ', 'ÂΩ≠', 'Âêï', 'Ëãè', 'Âç¢', 'Ëíã', 'Ëî°', 'Ë¥æ', '‰∏Å', 'È≠è', 'Ëñõ', 'Âè∂', 'Èòé', '‰Ωô', 'ÊΩò', 'Êùú', 'Êà¥', 'Â§è', 'Èíü', 'Ê±™', 'Áî∞', '‰ªª', 'Âßú', 'ËåÉ', 'Êñπ', 'Áü≥', 'Âßö', 'Ë∞≠', 'Âªñ', 'ÈÇπ', 'ÁÜä', 'Èáë', 'ÈôÜ', 'ÈÉù', 'Â≠î', 'ÁôΩ', 'Â¥î', 'Â∫∑', 'ÊØõ', 'ÈÇ±', 'Áß¶', 'Ê±ü', 'Âè≤', 'È°æ', '‰æØ', 'ÈÇµ', 'Â≠ü', 'Èæô', '‰∏á', 'ÊÆµ', 'Èõ∑', 'Èí±', 'Ê±§', 'Â∞π', 'Èªé', 'Êòì', 'Â∏∏', 'Ê≠¶', '‰πî', 'Ë¥∫', 'Ëµñ', 'Èæö', 'Êñá'];
                    const givenNames = ['‰ºü', 'Ëä≥', 'Â®ú', 'ÁßÄËã±', 'Êïè', 'Èùô', '‰∏Ω', 'Âº∫', 'Á£ä', 'ÂÜõ', 'Ê¥ã', 'Âãá', 'Ëâ≥', 'Êù∞', 'Â®ü', 'Ê∂õ', 'Êòé', 'Ë∂Ö', 'ÁßÄÂÖ∞', 'Èúû', 'Âπ≥', 'Âàö', 'Ê°ÇËã±', 'Âª∫Âçé', 'Âª∫ÂõΩ', 'Âª∫ÂÜõ', 'Âª∫Âπ≥', 'Âª∫Âçé', 'Âª∫Êòé', 'Âª∫Âº∫', 'Âª∫‰ºü', 'Âª∫Âãá', 'Âª∫Êù∞', 'Âª∫Ê≥¢', 'Âª∫Ê∂õ', 'Âª∫Êñå', 'Âª∫Ëæâ', 'Âª∫Â≥∞', 'Âª∫Êûó', 'Âª∫‰∏ú', 'Âª∫Âçó', 'Âª∫Ë•ø', 'Âª∫Âåó', 'Âª∫‰∏≠', 'Âª∫Âíå', 'Âª∫ÂÆâ', 'Âª∫Â∫∑', 'Âª∫Êñá', 'Âª∫Ê≠¶', 'Âª∫Âæ∑', 'Âª∫‰ªÅ', 'Âª∫‰πâ', 'Âª∫Á§º', 'Âª∫Êô∫', 'Âª∫‰ø°', 'Âª∫Âø†', 'Âª∫Â≠ù', 'Âª∫ËäÇ', 'Âª∫Âªâ', 'Âª∫ËÄª', 'Âª∫Âãá', 'Âª∫Âàö', 'Âª∫Âº∫', 'Âª∫‰ºü', 'Âª∫Êù∞', 'Âª∫Ê≥¢', 'Âª∫Ê∂õ', 'Âª∫Êñå', 'Âª∫Ëæâ', 'Âª∫Â≥∞', 'Âª∫Êûó', 'Âª∫‰∏ú', 'Âª∫Âçó', 'Âª∫Ë•ø', 'Âª∫Âåó', 'Âª∫‰∏≠', 'Âª∫Âíå', 'Âª∫ÂÆâ', 'Âª∫Â∫∑', 'Âª∫Êñá', 'Âª∫Ê≠¶', 'Âª∫Âæ∑', 'Âª∫‰ªÅ', 'Âª∫‰πâ', 'Âª∫Á§º', 'Âª∫Êô∫', 'Âª∫‰ø°', 'Âª∫Âø†', 'Âª∫Â≠ù', 'Âª∫ËäÇ', 'Âª∫Âªâ', 'Âª∫ËÄª'];
                    const factions = ['ËúÄÂõΩ', 'È≠èÂõΩ', 'Âê¥ÂõΩ', 'ÈΩêÂõΩ', 'Ê•öÂõΩ', 'ÁáïÂõΩ', 'Èü©ÂõΩ', 'ËµµÂõΩ', 'Áß¶ÂõΩ', 'ÊôãÂõΩ', 'ÂÆãÂõΩ', 'Âç´ÂõΩ', 'ÈÉëÂõΩ', 'È≤ÅÂõΩ', 'Ë∂äÂõΩ', '‰∏≠Â±±ÂõΩ', 'ÊªïÂõΩ', 'ËñõÂõΩ', 'ËéíÂõΩ', 'ÈÇæÂõΩ', 'ÈÉØÂõΩ', 'Â∞èÈÇæÂõΩ', 'ÈÑ´ÂõΩ', 'ÈÑÖÂõΩ', 'ÈÑ´ÂõΩ', 'ÈÑÖÂõΩ', 'ÈÑ´ÂõΩ', 'ÈÑÖÂõΩ', 'ÈÑ´ÂõΩ', 'ÈÑÖÂõΩ'];

                    // È¢ÑÁîüÊàêÈöèÊú∫È¢úËâ≤Ê±†
                    const colorPool = [
                        '#e74c3c', '#3498db', '#f39c12', '#9b59b6', '#27ae60', '#1abc9c', '#34495e', '#e67e22',
                        '#8e44ad', '#2980b9', '#d35400', '#c0392b', '#16a085', '#f1c40f', '#e74c3c', '#3498db',
                        '#f39c12', '#9b59b6', '#27ae60', '#1abc9c', '#34495e', '#e67e22', '#8e44ad', '#2980b9',
                        '#d35400', '#c0392b', '#16a085', '#f1c40f', '#95a5a6', '#7f8c8d', '#2c3e50', '#ecf0f1'
                    ];

                    const newCharacters = [];
                    let totalActionsPerDay = 0;

                    // 4. ÁîüÊàêËßíËâ≤Âπ∂ËÆ°ÁÆóÁêÜËÆ∫Âπ≥ÂùáÂÄº
                    for (let i = 0; i < characterCount; i++) {
                        const randomFactor = 0.5 + Math.random();
                        const finalSpeed = Math.max(0.1, targetSpeed * randomFactor);

                        // ÁîüÊàêÈöèÊú∫ÂêçÂ≠ó
                        const surname = surnames[Math.floor(Math.random() * surnames.length)];
                        const givenName = givenNames[Math.floor(Math.random() * givenNames.length)];
                        const randomName = surname + givenName;

                        // ÈöèÊú∫ÈòµËê•
                        const randomFaction = factions[Math.floor(Math.random() * factions.length)];

                        // ÂàÜÈÖçÂõ∫ÂÆöÈöèÊú∫È¢úËâ≤ÔºàÂü∫‰∫éËßíËâ≤IDÁ°Æ‰øù‰∏ÄËá¥ÊÄßÔºâ
                        const colorIndex = (Date.now() + i) % colorPool.length;
                        const randomColor = colorPool[colorIndex];

                        newCharacters.push({
                            id: Date.now() + i,
                            name: randomName,
                            faction: randomFaction,
                            speed: parseFloat(finalSpeed.toFixed(2)),
                            isActive: true,
                            customColor: randomColor  // Ê∑ªÂä†Ëá™ÂÆö‰πâÈ¢úËâ≤Â±ûÊÄß
                        });

                        const intervalDays = Math.ceil(baseFactor / finalSpeed);
                        if (intervalDays > 0) {
                            totalActionsPerDay += 1 / intervalDays;
                        }
                    }
                    gameState.ctbManager.characters = newCharacters;

                    // 5. ÂÆâÊéíÈ¶ñÊ¨°Ë°åÂä®
                    gameState.ctbManager.characters.forEach(char => {
                        const intervalDays = Math.ceil(baseFactor / char.speed);
                        const intervalHours = intervalDays * 24;

                        // È¶ñÊ¨°Ë°åÂä®Êó∂Èó¥Âú® (0, intervalHours] Âå∫Èó¥ÂÜÖÈöèÊú∫ÂàÜÂ∏É
                        const initialDelayHours = Math.floor(Math.random() * intervalHours) + 1;
                        const triggerTime = gameState.timeManager.totalHours + initialDelayHours;

                        gameState.ctbManager.actionQueue.push({
                            id: gameState.ctbManager.nextEventId++,
                            characterId: char.id,
                            characterName: char.name,
                            triggerTime: triggerTime,
                            actionType: 'attack'
                        });
                    });

                    // 6. ÊéíÂ∫èË°åÂä®ÈòüÂàó
                    gameState.ctbManager.actionQueue.sort((a, b) => a.triggerTime - b.triggerTime);

                    gameState.ctbManager.isInitialized = true;

                    // 7. ÊòæÁ§∫ÁêÜËÆ∫ËÆ°ÁÆóÁªìÊûú
                    const resultText = `--- 100‰∫∫ÊµãËØïÁªìÊûú ---\nËßíËâ≤Êï∞Èáè: ${characterCount}\nÁõÆÊ†áË°åÂä®Èó¥Èöî: ${averageIntervalDays} Â§©\nÁêÜËÆ∫Âπ≥ÂùáÊØèÊó•Ë°åÂä®: ${totalActionsPerDay.toFixed(2)} ‰∫∫\n\nüí° ÈÄÇÂêàÊµãËØïË°åÂä®È°∫Â∫èÈ¢ÑÊµãÁ´ñÊù°ÊïàÊûú`;
                    resultDiv.textContent = resultText;

                    addActionLog(`‚úÖ 100‰∫∫ÊµãËØïÂàùÂßãÂåñÂÆåÊàêÔºåÂ∑≤ÁîüÊàê ${characterCount} ‰∏™ËßíËâ≤„ÄÇ`);

                    // 8. Êõ¥Êñ∞ÊâÄÊúâÊòæÁ§∫
                    updateAllDisplays();

                } catch (e) {
                    console.error("100‰∫∫ÊµãËØïÂàùÂßãÂåñÂá∫Èîô:", e);
                    resultDiv.textContent = "ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞„ÄÇ";
                    addActionLog("‚ùå 100‰∫∫ÊµãËØïÂàùÂßãÂåñÂ§±Ë¥•„ÄÇ");
                }
            }, 50);
        }

        function runStressTest() {
            addActionLog("üî• ÂºÄÂßãÂéãÂäõÊµãËØïÂàùÂßãÂåñ...");

            const resultDiv = document.getElementById('stressTestResult');
            resultDiv.textContent = "ÂàùÂßãÂåñ‰∏≠...";

            setTimeout(() => {
                try {
                    // 1. ÈáçÁΩÆÁ≥ªÁªüÁä∂ÊÄÅ
                    resetCTB(true);

                    // 2. ËÆæÁΩÆÂèÇÊï∞
                    const characterCount = 10000;
                    const averageIntervalDays = 90;
                    const baseFactor = gameState.ctbManager.baseFactor;
                    const targetSpeed = baseFactor / averageIntervalDays;

                    // 3. ÁîüÊàêÈöèÊú∫ÂêçÂ≠óÂíåÈ¢úËâ≤
                    const surnames = ['Âº†', 'Êùé', 'Áéã', 'Ëµµ', 'Èôà', 'Âàò', 'Êù®', 'ÈªÑ', 'Âë®', 'Âê¥', 'Âæê', 'Â≠ô', 'ËÉ°', 'Êú±', 'È´ò', 'Êûó', '‰Ωï', 'ÈÉ≠', 'È©¨', 'ÁΩó', 'Ê¢Å', 'ÂÆã', 'ÈÉë', 'Ë∞¢', 'Èü©', 'Âîê', 'ÂÜØ', '‰∫é', 'Ëë£', 'Ëêß', 'Á®ã', 'Êõπ', 'Ë¢Å', 'ÈÇì', 'ËÆ∏', 'ÂÇÖ', 'Ê≤à', 'Êõæ', 'ÂΩ≠', 'Âêï', 'Ëãè', 'Âç¢', 'Ëíã', 'Ëî°', 'Ë¥æ', '‰∏Å', 'È≠è', 'Ëñõ', 'Âè∂', 'Èòé', '‰Ωô', 'ÊΩò', 'Êùú', 'Êà¥', 'Â§è', 'Èíü', 'Ê±™', 'Áî∞', '‰ªª', 'Âßú', 'ËåÉ', 'Êñπ', 'Áü≥', 'Âßö', 'Ë∞≠', 'Âªñ', 'ÈÇπ', 'ÁÜä', 'Èáë', 'ÈôÜ', 'ÈÉù', 'Â≠î', 'ÁôΩ', 'Â¥î', 'Â∫∑', 'ÊØõ', 'ÈÇ±', 'Áß¶', 'Ê±ü', 'Âè≤', 'È°æ', '‰æØ', 'ÈÇµ', 'Â≠ü', 'Èæô', '‰∏á', 'ÊÆµ', 'Èõ∑', 'Èí±', 'Ê±§', 'Â∞π', 'Èªé', 'Êòì', 'Â∏∏', 'Ê≠¶', '‰πî', 'Ë¥∫', 'Ëµñ', 'Èæö', 'Êñá'];
                    const givenNames = ['‰ºü', 'Ëä≥', 'Â®ú', 'ÁßÄËã±', 'Êïè', 'Èùô', '‰∏Ω', 'Âº∫', 'Á£ä', 'ÂÜõ', 'Ê¥ã', 'Âãá', 'Ëâ≥', 'Êù∞', 'Â®ü', 'Ê∂õ', 'Êòé', 'Ë∂Ö', 'ÁßÄÂÖ∞', 'Èúû', 'Âπ≥', 'Âàö', 'Ê°ÇËã±', 'Âª∫Âçé', 'Âª∫ÂõΩ', 'Âª∫ÂÜõ', 'Âª∫Âπ≥', 'Âª∫Âçé', 'Âª∫Êòé', 'Âª∫Âº∫', 'Âª∫‰ºü', 'Âª∫Âãá', 'Âª∫Êù∞', 'Âª∫Ê≥¢', 'Âª∫Ê∂õ', 'Âª∫Êñå', 'Âª∫Ëæâ', 'Âª∫Â≥∞', 'Âª∫Êûó', 'Âª∫‰∏ú', 'Âª∫Âçó', 'Âª∫Ë•ø', 'Âª∫Âåó', 'Âª∫‰∏≠', 'Âª∫Âíå', 'Âª∫ÂÆâ', 'Âª∫Â∫∑', 'Âª∫Êñá', 'Âª∫Ê≠¶', 'Âª∫Âæ∑', 'Âª∫‰ªÅ', 'Âª∫‰πâ', 'Âª∫Á§º', 'Âª∫Êô∫', 'Âª∫‰ø°', 'Âª∫Âø†', 'Âª∫Â≠ù', 'Âª∫ËäÇ', 'Âª∫Âªâ', 'Âª∫ËÄª', 'Âª∫Âãá', 'Âª∫Âàö', 'Âª∫Âº∫', 'Âª∫‰ºü', 'Âª∫Êù∞', 'Âª∫Ê≥¢', 'Âª∫Ê∂õ', 'Âª∫Êñå', 'Âª∫Ëæâ', 'Âª∫Â≥∞', 'Âª∫Êûó', 'Âª∫‰∏ú', 'Âª∫Âçó', 'Âª∫Ë•ø', 'Âª∫Âåó', 'Âª∫‰∏≠', 'Âª∫Âíå', 'Âª∫ÂÆâ', 'Âª∫Â∫∑', 'Âª∫Êñá', 'Âª∫Ê≠¶', 'Âª∫Âæ∑', 'Âª∫‰ªÅ', 'Âª∫‰πâ', 'Âª∫Á§º', 'Âª∫Êô∫', 'Âª∫‰ø°', 'Âª∫Âø†', 'Âª∫Â≠ù', 'Âª∫ËäÇ', 'Âª∫Âªâ', 'Âª∫ËÄª'];
                    const factions = ['ËúÄÂõΩ', 'È≠èÂõΩ', 'Âê¥ÂõΩ', 'ÈΩêÂõΩ', 'Ê•öÂõΩ', 'ÁáïÂõΩ', 'Èü©ÂõΩ', 'ËµµÂõΩ', 'Áß¶ÂõΩ', 'ÊôãÂõΩ', 'ÂÆãÂõΩ', 'Âç´ÂõΩ', 'ÈÉëÂõΩ', 'È≤ÅÂõΩ', 'Ë∂äÂõΩ', '‰∏≠Â±±ÂõΩ', 'ÊªïÂõΩ', 'ËñõÂõΩ', 'ËéíÂõΩ', 'ÈÇæÂõΩ', 'ÈÉØÂõΩ', 'Â∞èÈÇæÂõΩ', 'ÈÑ´ÂõΩ', 'ÈÑÖÂõΩ', 'ÈÑ´ÂõΩ', 'ÈÑÖÂõΩ', 'ÈÑ´ÂõΩ', 'ÈÑÖÂõΩ', 'ÈÑ´ÂõΩ', 'ÈÑÖÂõΩ'];

                    // È¢ÑÁîüÊàêÈöèÊú∫È¢úËâ≤Ê±†
                    const colorPool = [
                        '#e74c3c', '#3498db', '#f39c12', '#9b59b6', '#27ae60', '#1abc9c', '#34495e', '#e67e22',
                        '#8e44ad', '#2980b9', '#d35400', '#c0392b', '#16a085', '#f1c40f', '#e74c3c', '#3498db',
                        '#f39c12', '#9b59b6', '#27ae60', '#1abc9c', '#34495e', '#e67e22', '#8e44ad', '#2980b9',
                        '#d35400', '#c0392b', '#16a085', '#f1c40f', '#95a5a6', '#7f8c8d', '#2c3e50', '#ecf0f1'
                    ];

                    const newCharacters = [];
                    let totalActionsPerDay = 0;

                    // 4. ÁîüÊàêËßíËâ≤Âπ∂ËÆ°ÁÆóÁêÜËÆ∫Âπ≥ÂùáÂÄº
                    for (let i = 0; i < characterCount; i++) {
                        const randomFactor = 0.5 + Math.random();
                        const finalSpeed = Math.max(0.1, targetSpeed * randomFactor);

                        // ÁîüÊàêÈöèÊú∫ÂêçÂ≠ó
                        const surname = surnames[Math.floor(Math.random() * surnames.length)];
                        const givenName = givenNames[Math.floor(Math.random() * givenNames.length)];
                        const randomName = surname + givenName;

                        // ÈöèÊú∫ÈòµËê•
                        const randomFaction = factions[Math.floor(Math.random() * factions.length)];

                        // ÂàÜÈÖçÂõ∫ÂÆöÈöèÊú∫È¢úËâ≤ÔºàÂü∫‰∫éËßíËâ≤IDÁ°Æ‰øù‰∏ÄËá¥ÊÄßÔºâ
                        const colorIndex = (Date.now() + i) % colorPool.length;
                        const randomColor = colorPool[colorIndex];

                        newCharacters.push({
                            id: Date.now() + i,
                            name: randomName,
                            faction: randomFaction,
                            speed: parseFloat(finalSpeed.toFixed(2)),
                            isActive: true,
                            customColor: randomColor  // Ê∑ªÂä†Ëá™ÂÆö‰πâÈ¢úËâ≤Â±ûÊÄß
                        });

                        const intervalDays = Math.ceil(baseFactor / finalSpeed);
                        if (intervalDays > 0) {
                            totalActionsPerDay += 1 / intervalDays;
                        }
                    }
                    gameState.ctbManager.characters = newCharacters;

                    // 5. ÂÆâÊéíÈ¶ñÊ¨°Ë°åÂä®
                    gameState.ctbManager.characters.forEach(char => {
                        const intervalDays = Math.ceil(baseFactor / char.speed);
                        const intervalHours = intervalDays * 24;

                        // È¶ñÊ¨°Ë°åÂä®Êó∂Èó¥Âú® (0, intervalHours] Âå∫Èó¥ÂÜÖÈöèÊú∫ÂàÜÂ∏É
                        const initialDelayHours = Math.floor(Math.random() * intervalHours) + 1;
                        const triggerTime = gameState.timeManager.totalHours + initialDelayHours;

                        gameState.ctbManager.actionQueue.push({
                            id: gameState.ctbManager.nextEventId++,
                            characterId: char.id,
                            characterName: char.name,
                            triggerTime: triggerTime,
                            actionType: 'attack'
                        });
                    });

                    // 6. ÊéíÂ∫èË°åÂä®ÈòüÂàó
                    gameState.ctbManager.actionQueue.sort((a, b) => a.triggerTime - b.triggerTime);

                    gameState.ctbManager.isInitialized = true;

                    // 7. ÊòæÁ§∫ÁêÜËÆ∫ËÆ°ÁÆóÁªìÊûú
                    const resultText = `--- ÂéãÂäõÊµãËØïÁªìÊûú ---\nËßíËâ≤Êï∞Èáè: ${characterCount}\nÁõÆÊ†áË°åÂä®Èó¥Èöî: ${averageIntervalDays} Â§©\nÁêÜËÆ∫Âπ≥ÂùáÊØèÊó•Ë°åÂä®: ${totalActionsPerDay.toFixed(2)} ‰∫∫`;
                    resultDiv.textContent = resultText;

                    addActionLog(`‚úÖ ÂéãÂäõÊµãËØïÂàùÂßãÂåñÂÆåÊàêÔºåÂ∑≤ÁîüÊàê ${characterCount} ‰∏™ËßíËâ≤„ÄÇ`);

                    // 8. Êõ¥Êñ∞ÊâÄÊúâÊòæÁ§∫
                    updateAllDisplays();

                } catch (e) {
                    console.error("ÂéãÂäõÊµãËØïÂàùÂßãÂåñÂá∫Èîô:", e);
                    resultDiv.textContent = "ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞„ÄÇ";
                    addActionLog("‚ùå ÂéãÂäõÊµãËØïÂàùÂßãÂåñÂ§±Ë¥•„ÄÇ");
                }
            }, 50);
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñÊòæÁ§∫
        document.addEventListener('DOMContentLoaded', function() {
            updateAllDisplays();
            addActionLog("Á≥ªÁªüÂêØÂä®ÂÆåÊàê");
            addActionLog("üí° ÊèêÁ§∫ÔºöÁÇπÂáª'ÂàùÂßãÂåñCTB'Â∞ÜÊ∑ªÂä†ËßíËâ≤Âπ∂ÂÆâÊéíÂàùÂßãË°åÂä®Êó∂Èó¥");
            addActionLog("   ÂàùÂßãÂåñÂêéÔºåÁ≥ªÁªü‰ºö‰∏∫ÊØè‰∏™ËßíËâ≤ËÆ°ÁÆóÁ¨¨‰∏ÄÊ¨°Ë°åÂä®ÁöÑÊó∂Èó¥");
        });
    </script>
</body>
</html>